@page
@model IndexModel
@{
    ViewData["Title"] = "Pixelboard Client";
}

<div class="text-center">
    <h1 class="display-4">
        Pixelboard
        <environment include="Development">
            <span class="badge bg-warning text-dark">DEV</span>
        </environment>
    </h1>

    @if (Model.ErrorMessage != null)
    {
        <div class="alert alert-danger">
            @Model.ErrorMessage
        </div>
    }

    <!-- INFO BOX -->
    <div class="card mb-3" style="max-width: 600px; margin: 0 auto;">
        <div class="card-header bg-info text-white">
            <strong>📊 Pixelboard Status</strong>
        </div>
        <div class="card-body text-start">
            <div class="row">
                <div class="col-6">
                    <small class="text-muted">Seite geladen um:</small><br>
                    <strong id="pageLoadTime">@DateTime.Now.ToString("HH:mm:ss")</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">Ladezeit (Cache):</small><br>
                    <strong class="text-success">@Model.LoadTimeMs ms</strong>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <small class="text-muted">API URL:</small><br>
                    <strong style="font-size: 0.8em;">@Model.ApiUrl</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">Pixels geladen:</small><br>
                    <strong class="text-primary">256</strong>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-sm btn-primary" onclick="location.reload(true)">
                    🔄 Seite neu laden (Hard Refresh)
                </button>
                <button class="btn btn-sm btn-secondary" onclick="clearCacheAndReload()">
                    🗑️ Cache löschen & neu laden
                </button>
            </div>
            <hr>
            <div>
                <small class="text-muted">📝 Letzte Aktionen:</small>
                <div id="logBox" style="max-height: 150px; overflow-y: auto; font-size: 0.85em; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <div class="text-muted">Noch keine Aktionen...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label for="teamNumber" class="form-label"><strong>Team Nummer:</strong></label>
        <input type="number" id="teamNumber" class="form-control" style="max-width: 150px; margin: 0 auto;" value="1" min="1" max="10" />
    </div>

    <div class="board-container">
        @for (int y = 0; y < Model.Pixels.GetLength(1); y++)
        {
            @for (int x = 0; x < Model.Pixels.GetLength(0); x++)
            {
                var pixel = Model.Pixels[x, y];
                <div id="pixel-@x-@y"
                     class="pixel"
                     data-x="@x"
                     data-y="@y"
                     style="background-color: rgb(@pixel.Red,@pixel.Green,@pixel.Blue);"
                     onclick="setPixel(@x, @y)">
                </div>
            }
        }
    </div>

    <div class="mt-3">
        <small class="text-muted">💡 Tipp: Klicken Sie auf ein Pixel um es einzufärben</small>
    </div>
</div>

@section Scripts {
    <script>
        let logCounter = 0;

        function addLog(message, type = 'info') {
            logCounter++;
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('de-CH');

            // Entferne "Noch keine Aktionen" beim ersten Log
            if (logCounter === 1) {
                logBox.innerHTML = '';
            }

            const colors = {
                'info': '#0dcaf0',
                'success': '#198754',
                'error': '#dc3545',
                'warning': '#ffc107'
            };

            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.style.borderLeft = `3px solid ${colors[type] || colors['info']}`;
            logEntry.style.paddingLeft = '8px';
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;

            logBox.insertBefore(logEntry, logBox.firstChild);

            // Behalte nur die letzten 10 Einträge
            while (logBox.children.length > 10) {
                logBox.removeChild(logBox.lastChild);
            }
        }

        function clearCacheAndReload() {
            addLog('Cache wird geleert...', 'warning');
            setTimeout(() => {
                location.reload(true);
            }, 500);
        }

        async function setPixel(x, y) {
            const team = document.getElementById('teamNumber').value;

            addLog(`Versuche Pixel (${x},${y}) zu setzen für Team ${team}...`, 'info');

            try {
                // ✅ NEUE API Route
                const response = await fetch('/api/pixel/set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ x: x, y: y, team: parseInt(team) })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`❌ HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ Pixel (${x},${y}) erfolgreich gesetzt!`, 'success');
                    console.log('Pixel gesetzt:', result.message);

                    const element = document.getElementById(`pixel-${x}-${y}`);
                    if (element) {
                        element.style.opacity = '0.5';
                        element.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            element.style.opacity = '1';
                            element.style.transform = 'scale(1)';
                        }, 500);
                    }
                } else {
                    addLog(`❌ Fehler: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`❌ Request Fehler: ${error.message}`, 'error');
                console.error('Request Fehler:', error);
            }
        }

        // Initial Log
        window.addEventListener('DOMContentLoaded', () => {
            addLog('Seite geladen! Pixelboard bereit.', 'success');
        });

        // Auto-refresh Info alle 15 Sekunden
        setInterval(() => {
            const now = new Date().toLocaleTimeString('de-CH');
            document.getElementById('pageLoadTime').textContent = now + ' (auto)';
            addLog('⏰ Auto-Update durchgeführt', 'info');
        }, 15000);
    </script>
}
