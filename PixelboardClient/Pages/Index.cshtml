@page
@model IndexModel
@{
    ViewData["Title"] = "Pixelboard Client";
}

<div class="container-fluid">
    <div class="header-section">
        <h1 class="display-4">🎨 Pixelboard Client</h1>
        <p class="lead">Modul 321 - Verteilte Systeme programmieren</p>
        <div class="environment-info">
            <span class="badge bg-info">Umgebung: @Model.CurrentEnvironment</span>
            <span class="badge bg-secondary">API: @Model.ApiBaseUrl</span>
        </div>
    </div>

    @if (Model.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="bi bi-exclamation-triangle"></i> Fehler:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Steuerungsbereich - Laden -->
    <div class="control-panel">
        <h4><i class="bi bi-download"></i> Pixelboard laden</h4>
        <div class="row g-3">
            <div class="col-md-6">
                <form method="post" asp-page-handler="LoadParallel">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-lightning-charge"></i> Parallel laden (Schnell)
                    </button>
                </form>
            </div>
            <div class="col-md-6">
                <form method="post" asp-page-handler="LoadSequential">
                    <button type="submit" class="btn btn-secondary btn-lg w-100">
                        <i class="bi bi-list-ol"></i> Sequenziell laden (1 nach dem anderen)
                    </button>
                </form>
            </div>
        </div>

        @if (Model.LoadTimeMs.HasValue)
        {
            <div class="performance-info">
                <div class="alert alert-success">
                    <strong>✓ Geladen:</strong> @Model.LoadMethod in
                    <strong>@Model.LoadTimeMs ms</strong>
                    (@Model.TotalPixels Pixel)
                    <span class="badge bg-success">
                        ~@Math.Round(Model.TotalPixels / (double)Model.LoadTimeMs.Value * 1000, 0) Pixel/Sekunde
                    </span>
                </div>
            </div>
        }
    </div>

    <!-- Steuerungsbereich - Pixel setzen (BONUS) -->
    @if (Model.Pixels != null)
    {
        <div class="control-panel">
            <h4><i class="bi bi-palette"></i> Pixel setzen (Bonus-Feature)</h4>

            @if (Model.SetPixelResult != null)
            {
                <div class="alert @(Model.SetPixelResult.StartsWith("✓") ? "alert-success" : "alert-warning") alert-dismissible fade show">
                    @Model.SetPixelResult
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form method="post" asp-page-handler="SetPixel">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">X Position (0-15)</label>
                        <input type="number" class="form-control" asp-for="SelectedX" min="0" max="15" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Y Position (0-15)</label>
                        <input type="number" class="form-control" asp-for="SelectedY" min="0" max="15" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Rot (0-255)</label>
                        <input type="number" class="form-control" asp-for="Red" min="0" max="255" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Grün (0-255)</label>
                        <input type="number" class="form-control" asp-for="Green" min="0" max="255" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Blau (0-255)</label>
                        <input type="number" class="form-control" asp-for="Blue" min="0" max="255" required />
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-brush"></i> Setzen
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="color-preview" style="background-color: rgb(@Model.Red, @Model.Green, @Model.Blue);">
                            Vorschau: RGB(@Model.Red, @Model.Green, @Model.Blue)
                        </div>
                    </div>
                </div>
            </form>
        </div>
    }

    <!-- Pixelboard Anzeige -->
    @if (Model.Pixels != null)
    {
        <div class="board-section">
            <div class="board-wrapper">
                <div class="board-container" id="pixelboard">
                    @for (int y = 0; y < Model.Pixels.GetLength(1); y++)
                    {
                        @for (int x = 0; x < Model.Pixels.GetLength(0); x++)
                        {
                            var pixel = Model.Pixels[x, y];
                            var cssClass = "pixel";
                            if (pixel.IsBlack()) cssClass += " pixel-empty";
                            if (pixel.IsErrorColor()) cssClass += " pixel-error";

                            <div class="@cssClass"
                                 style="background-color: rgb(@pixel.Red, @pixel.Green, @pixel.Blue);"
                                 data-x="@x"
                                 data-y="@y"
                                 data-r="@pixel.Red"
                                 data-g="@pixel.Green"
                                 data-b="@pixel.Blue"
                                 onclick="selectPixel(this)"
                                 title="(@x, @y)">
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Legende -->
            <div class="legend">
                <h5><i class="bi bi-info-circle"></i> Legende</h5>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgb(0,0,0);"></div>
                        <span>Schwarz = Leer / Nicht initialisiert</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgb(255,0,255);"></div>
                        <span>Pink = Fehler beim Laden</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgb(255,0,0);"></div>
                        <span>Rot = Team Rot</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgb(0,255,0);"></div>
                        <span>Grün = Team Grün</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgb(0,0,255);"></div>
                        <span>Blau = Team Blau</span>
                    </div>
                </div>
            </div>

            <!-- Pixel Info Anzeige -->
            <div id="pixel-info" class="pixel-info" style="display: none;">
                <h6><i class="bi bi-cursor"></i> Ausgewähltes Pixel</h6>
                <div id="pixel-details"></div>
            </div>
        </div>
    }
    else
    {
        <div class="welcome-section">
            <div class="card text-center">
                <div class="card-body">
                    <h3><i class="bi bi-arrow-up"></i> Wählen Sie eine Lademethode</h3>
                    <p class="text-muted">Klicken Sie auf einen der Buttons oben, um das Pixelboard zu laden.</p>

                    <div class="info-boxes mt-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-box">
                                    <h5><i class="bi bi-lightning"></i> Parallel</h5>
                                    <p>Alle Pixel werden gleichzeitig geladen. Sehr schnell!</p>
                                    <p class="text-muted"><small>Verwendet Task.WhenAll() für simultane HTTP-Requests</small></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <h5><i class="bi bi-list-ol"></i> Sequenziell</h5>
                                    <p>Pixel werden nacheinander geladen. Langsamer, aber einfacher zu debuggen.</p>
                                    <p class="text-muted"><small>Verwendet await in einer Schleife</small></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <strong><i class="bi bi-info-circle"></i> Wichtiger Hinweis:</strong>
                        Falls das Board komplett schwarz ist, müssen Sie das Spiel initialisieren:
                        <ol class="text-start mt-2">
                            <li>Öffnen Sie <a href="@(Model.ApiBaseUrl)/Admin" target="_blank">@(Model.ApiBaseUrl)/Admin</a></li>
                            <li>Klicken Sie auf <strong>"Start Game"</strong></li>
                            <li>Laden Sie diese Seite neu</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function selectPixel(element) {
            const x = element.getAttribute('data-x');
            const y = element.getAttribute('data-y');
            const r = element.getAttribute('data-r');
            const g = element.getAttribute('data-g');
            const b = element.getAttribute('data-b');

            // Formular ausfüllen
            document.querySelector('input[name="SelectedX"]').value = x;
            document.querySelector('input[name="SelectedY"]').value = y;
            document.querySelector('input[name="Red"]').value = r;
            document.querySelector('input[name="Green"]').value = g;
            document.querySelector('input[name="Blue"]').value = b;

            // Update color preview
            updateColorPreview(r, g, b);

            // Pixel Info anzeigen
            const infoDiv = document.getElementById('pixel-info');
            const detailsDiv = document.getElementById('pixel-details');

            detailsDiv.innerHTML = `
                <p><strong>Position:</strong> (${x}, ${y})</p>
                <p><strong>RGB:</strong> (${r}, ${g}, ${b})</p>
                <p><strong>Hex:</strong> #${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}</p>
                <p class="text-muted mt-2"><i class="bi bi-hand-index"></i> Die Werte wurden ins Formular übernommen. Ändern Sie sie und klicken Sie auf "Setzen".</p>
            `;

            infoDiv.style.display = 'block';

            // Highlight selected pixel
            document.querySelectorAll('.pixel').forEach(p => p.classList.remove('pixel-selected'));
            element.classList.add('pixel-selected');

            // Scroll zum Formular
            document.querySelector('.control-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function componentToHex(c) {
            const hex = parseInt(c).toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function updateColorPreview(r, g, b) {
            const preview = document.querySelector('.color-preview');
            if (preview) {
                preview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                preview.textContent = `Vorschau: RGB(${r}, ${g}, ${b})`;
            }
        }

        // Update preview when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['Red', 'Green', 'Blue'];
            inputs.forEach(name => {
                const input = document.querySelector(`input[name="${name}"]`);
                if (input) {
                    input.addEventListener('input', function() {
                        const r = document.querySelector('input[name="Red"]').value;
                        const g = document.querySelector('input[name="Green"]').value;
                        const b = document.querySelector('input[name="Blue"]').value;
                        updateColorPreview(r, g, b);
                    });
                }
            });
        });
    </script>
}
