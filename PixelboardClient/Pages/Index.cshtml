@page
@model IndexModel
@{
    ViewData["Title"] = "Pixelboard Client";
}

<style>
    :root {
        --bg: #161512;
        --surface: #1f1d1b;
        --border: #2e2b28;
        --accent: #b58863;
        --text: #d1cfc9;
        --danger: #c84b31;
        --success: #51cf66;
        --warning: #ffca3a;
        --info: #5b8cb0;
    }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: 'Noto Sans', sans-serif;
    }

    .pixel {
        width: 28px;
        height: 28px;
        border: 1px solid var(--border);
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s;
    }

        .pixel:hover {
            transform: scale(1.15);
            box-shadow: 0 0 12px rgba(255,255,255,0.3);
        }

    .live-update {
        animation: pulse 1.8s ease-out;
    }
    @@keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255,255,255,0.7);
        }

        70% {
            box-shadow: 0 0 0 12px rgba(255,255,255,0);
        }

        100% {
            box-shadow: none;
        }
    }

    .budget-bar {
        height: 20px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
    }

    .budget-fill {
        height: 100%;
        transition: width 0.6s ease;
    }

    #debugLog {
        background: #0d0d0d;
        border: 1px solid #333;
        color: #aaa;
        padding: 10px;
        font-family: monospace;
        height: 180px;
        overflow-y: auto;
        border-radius: 4px;
    }
</style>

<div class="container my-4">
    <h1 class="text-center mb-4">Pixelboard Client</h1>

    <!-- Auth Status -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between">
            <strong>Auth Status</strong>
            <span id="authStatus" class="badge bg-danger">○ Gast</span>
        </div>
    </div>

    <!-- Budget Dashboard -->
    <div class="card mb-4">
        <div class="card-header">
            <strong>Team #@Model.TeamNumber Budget</strong>
        </div>
        <div class="card-body text-center">
            <div class="budget-bar mb-2">
                <div id="budgetBar" class="budget-fill" style="width:100%; background: linear-gradient(90deg, #51cf66, #10b981);"></div>
            </div>
            <h5 id="budgetText" class="fw-bold">100 / 100</h5>
            <small class="text-muted">Verbleibende Pixel zum Setzen</small>
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>🏆 Rangliste – Live Punkte</strong>
            <button class="btn btn-sm btn-outline-primary" onclick="loadLeaderboard()">🔄</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="table-dark">
                        <tr><th>#</th><th>Team</th><th>Punkte</th></tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="3" class="text-center text-muted">Laden...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pixelboard -->
    <div class="text-center mb-4">
        <div class="board-container mx-auto" style="max-width: 500px;">
            @for (int y = 0; y < 16; y++)
            {
                for (int x = 0; x < 16; x++)
                {
                    var p = Model.Pixels[x, y];
                    <div class="pixel" id="pixel-@x-@y"
                         style="background:rgb(@(p?.Red ?? 0),@(p?.Green ?? 0),@(p?.Blue ?? 0))"
                         onclick="setPixel(@x, @y)"></div>
                }
            }
        </div>
    </div>

    <!-- Debug Log -->
    <div class="card">
        <div class="card-header">Debug Log</div>
        <div id="debugLog" class="card-body"></div>
    </div>
</div>

<script>
    let eventSource = null;

    function addLog(msg, type = 'info') {
        const log = document.getElementById('debugLog');
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        line.style.color = type === 'success' ? '#51cf66' : type === 'warning' ? '#ffca3a' : type === 'error' ? '#ff6b6b' : '#ccc';
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    }

    function initSSE() {
        if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
            eventSource.close();
        }

        eventSource = new EventSource('/sse/pixels');

        eventSource.onopen = () => {
            addLog('✅ SSE Live-Updates verbunden (MS4 A1.2.2)', 'success');
        };

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const el = document.getElementById(`pixel-${data.x}-${data.y}`);
                if (el) {
                    el.style.backgroundColor = `rgb(${data.red}, ${data.green}, ${data.blue})`;
                    el.classList.add('live-update');
                    setTimeout(() => el.classList.remove('live-update'), 1800);
                }
                addLog(`Live: Pixel (${data.x},${data.y}) geändert`, 'info');
            } catch (err) {
                addLog('SSE Parse-Fehler: ' + err.message, 'error');
            }
        };

        eventSource.onerror = () => {
            addLog('△ SSE Verbindung verloren – reconnect in 2s...', 'warning');
            setTimeout(initSSE, 2000);
        };
    }

    async function loadTeamBudget() {
        const teamId = document.getElementById('teamNumber')?.value || 1;
        try {
            const res = await fetch(`/Index?handler=TeamBudget&teamId=${teamId}`);
            const data = await res.json();
            const budget = data.budgetRemaining || 100;

            document.getElementById('budgetText').textContent = `${budget} / 100`;
            const percent = Math.max(0, Math.min(100, (budget / 100) * 100));
            const bar = document.getElementById('budgetBar');
            bar.style.width = `${percent}%`;

            if (budget < 10) {
                bar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                addLog('⚠️ LOW BUDGET – nur noch ' + budget + ' Pixel!', 'warning');
            } else {
                bar.style.background = 'linear-gradient(90deg, #51cf66, #10b981)';
            }
        } catch (e) {
            addLog('Budget-Laden fehlgeschlagen', 'error');
        }
    }

    async function loadLeaderboard() {
        try {
            const res = await fetch('/api/teams/leaderboard');
            const teams = await res.json();
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            teams.sort((a, b) => b.points - a.points).forEach((t, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i+1}.</td>
                    <td>
                        <span class="badge px-3 py-2" style="background:rgb(${t.color?.r||0},${t.color?.g||0},${t.color?.b||0})">
                            #${t.id} ${t.name || 'Team '+t.id}
                        </span>
                    </td>
                    <td><strong>${t.points || 0}</strong></td>
                `;
                tbody.appendChild(tr);
            });

            addLog(`Rangliste geladen – ${teams.length} Teams`, 'success');
        } catch (e) {
            addLog('Leaderboard Fehler', 'error');
        }
    }

    // Auth Status Polling
    setInterval(async () => {
        try {
            const res = await fetch('/api/auth/status');
            const data = await res.json();
            const badge = document.getElementById('authStatus');
            badge.textContent = data.authenticated ? `● ${data.username}` : '○ Gast';
            badge.className = data.authenticated ? 'badge bg-success' : 'badge bg-danger';
        } catch {}
    }, 5000);

    function checkTokenExpiry() {
        fetch('/api/auth/token-status')
            .then(res => res.json())
            .then(data => {
                if (data.expired) {
                    addLog('❌ TOKEN ABGELAUFEN – Auto-Refresh wird versucht (MS4 A2.1)', 'warning');
                    // Optional: Automatischer Redirect zum Login (Challenge)
                    if (confirm('Token abgelaufen. Zum Login?')) {
                        window.location.href = '/Index?handler=Login';
                    }
                } else if (data.expiresIn <= 60) {
                    addLog(`⚠️ Token läuft in ${data.expiresIn} Sekunden ab (MS4 A2.1)`, 'warning');
                } else {
                    addLog(`Token läuft noch ${data.expiresIn} Sekunden (MS4 A2.1)`, 'info');
                }
            })
            .catch(err => {
                addLog('Token-Status Check fehlgeschlagen: ' + err.message, 'error');
            });
    }

    // Initialisierung
    window.addEventListener('DOMContentLoaded', () => {
        addLog('Pixelboard Client bereit', 'success');
        loadTeamBudget();
        loadLeaderboard();
        initSSE();

        setInterval(checkTokenExpiry, 30000);
        checkTokenExpiry();
    });
</script>